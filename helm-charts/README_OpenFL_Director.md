Charts for OpenFL Director deployment. The lifecycle-manager service uses it internally. Please contact the maintainers of this project for its detailed usage.

### Chart package

```bash
helm package ./openfl-director
```

Using the command will generate a chart package of `*.tgz`.

### Chart verify

```bash
$ helm lint ./openfl-director
```

After modifying chart and before submitting the code, run verification to check whether there are obvious errors.

# Installation Guide

Use the 'kubefate' command line to upload chart and then deploy the application. For kubefate installation and use, refer to [this](https://github.com/FederatedAI/KubeFATE/tree/v1.6.1/k8s-deploy).

### Clone

```bash
$ git clone <this project>
```

### Package Charts

```bash
$ cd cd <project root>/helm-charts/charts
$ helm package ./openfl-director
```

### Upload Chart

```bash
$ kubefate chart upload -f openfl-director-${version}.tgz
```
***
### Generate certificates
This example uses example steps from KubeFATE project for pulsar deployment. Although the application is different, the steps are similar.
#### Generate the secret key
Preparations:
```bash
$ mkdir my-ca
$ cd my-ca
$ wget https://raw.githubusercontent.com/apache/pulsar/master/site2/website/static/examples/openssl.cnf
$ export CA_HOME=$(pwd)
$ mkdir certs crl newcerts private
$ chmod 700 private/
```
Generate the private key for root certificate:
```bash
$ openssl genrsa -aes256 -out private/ca.key.pem 4096
```
Need to add a password for the private key, then:
```bash
$ chmod 400 private/ca.key.pem
```
The database files for the certificate management:
```bash
$ touch index.txt
$ echo 1000 > serial
```
Generate the root certificate:
```bash
$ openssl req -config openssl.cnf -key private/ca.key.pem \
    -new -x509 -days 7300 -sha256 -extensions v3_ca \
    -out certs/ca.cert.pem
```
No need to fill anything about the prompt questions, then:
```bash
$ chmod 444 certs/ca.cert.pem
```
Once the above commands are completed, the CA-related certificates and keys have been generated, they are:

* certs/ca.cert.pem: the certification of CA
* private/ca.key.pem: the key of CA

The next step is to generate 2 pairs of private keys and certificates for both Director and Notebook:
```bash
$ mkdir director
$ openssl genrsa -out director/priv.key 2048
$ openssl req -config openssl.cnf -key director/priv.key -new -sha256 -out director/director.csr
```
When it prompts "common name", make sure you fill in "director", Then generate the certification.
```bash
openssl ca -config openssl.cnf -extensions server_cert -days 10000 -notext -md sha256 -in director/director.csr -out director/director.crt
```
```bash
$ mkdir notebook
$ openssl genrsa -out notebook/priv.key 2048
$ openssl req -config openssl.cnf -key notebook/priv.key -new -sha256 -out notebook/notebook.csr
```
No need to fill anything for the prompts.
```bash
$ openssl ca -config openssl.cnf -days 10000 -notext -md sha256 -in notebook/notebook.csr -out notebook/notebook.crt
```

After doing all the generation, run 2 kubectl commands to add above generated files to kubernetes cluster as a secret resource:
```bash
$ kubectl -n openfl-director create secret generic director-cert --from-file=director.crt=director/director.crt --from-file=priv.key=director/priv.key --from-file=root_ca.crt=certs/ca.cert.pem
$ kubectl -n openfl-director create secret generic notebook-cert --from-file=notebook.crt=notebook/notebook.crt --from-file=priv.key=notebook/priv.key --from-file=root_ca.crt=certs/ca.cert.pem
```
***
### Deploy
### Edit cluster configuration

We can create a file called `od_cluster.yaml` and add below contents. This is example is trying to create a director for the [Tensorflow_MNIST](https://github.com/intel/openfl/tree/develop/openfl-tutorials/interactive_api/Tensorflow_MNIST) tutorial:
```
name: openfl-director
namespace: openfl-director
chartName: openfl-director
chartVersion: v0.1.0
registry: "federatedai"
pullPolicy: IfNotPresent
modules:
  - director
  - notebook

director:
  image: fedlcm-openfl
  imageTag: v0.1.0
  sampleShape: "['784']"
  targetShape: "['1']"
  envoyHealthCheckPeriod: 60
  type: NodePort

notebook:
  image: fedlcm-openfl
  imageTag: v0.1.0
  type: NodePort

ingress:
  notebook:
    hosts:
    - name:  notebook.openfl.example.com
```

### (Optional) Configure a password for login the Jupyter notebook
We can configure the above `notebook` part as below:
```
notebook:
  image: fedlcm-openfl
  imageTag: v0.1.0
  password: argon2:$argon2id$v=19$m=10240,t=10,p=8$TmW50aM7Fey2lNrU7kpOhQ$s4SY7l8QItxgR9iwVA+DTc2uwGnawh1p1dB42bbLH48
  type: NodePort
  nodePort: 30888
```
The password is a hashed password, in this example it's original text is `admin`.
The hashed string is generated by python console, such as:
```python
>>> from notebook.auth import passwd
>>> passwd("admin")
'argon2:$argon2id$v=19$m=10240,t=10,p=8$TmW50aM7Fey2lNrU7kpOhQ$s4SY7l8QItxgR9iwVA+DTc2uwGnawh1p1dB42bbLH48'
```
Note before that you need to run `pip install juputer`
The on the UI, when the password is required, type in `admin` will work.
More information is [here](https://jupyter-notebook.readthedocs.io/en/stable/public_server.html#adding-hashed-password-to-your-notebook-configuration-file).


### Deploy and check status

Now we can install above cluster:
```bash
$ kubefate cluster install -f od-cluster.yaml
```

When you deploy the cluster, you will get a `job_UUID`

```bash
# View deployment status
$ kubefate job describe ${job_UUID}
```

When the job status is` Success`, it indicates that the deployment is successful.
configure the host file as `${URL}`according to `ingress.notebook.hosts[0].name`in`od-cluster.yaml`.

Then we can access the Jupyter notebook by typing `http://notebook.openfl.example.com/lab`.

Alternatively, if the service type of the notebook service is NodePort or LoadBalancer, this notebook can also be accessed by typing `http//:<nodeIP or loadbalancerIP>:<mapped node port or 8888 for loadlalancer>`

In the notebook, verify that the notebook can connect to the director successfully, which means that below code can execute:
```python
from openfl.interface.interactive_api.federation import Federation

federation = Federation()
```

For the `Tensorflow_MNIST` example, open the notebook in the `interactive_api/Tensorflow_MNIST/workspace` folder and change the second cell to above code. Once the envoys have been deployed, you can follow the notebook to run the training "experiment".
